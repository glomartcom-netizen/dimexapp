<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>DimeX Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.min.js"></script>

<style>
body{margin:0;background:#000;color:#fff;font-family:Arial}
.top{background:#111;padding:20px;display:flex;justify-content:space-between}
.logo{color:gold;font-size:24px}
.btn{background:gold;border:none;padding:10px 18px;border-radius:6px}
.main{padding:20px}
.grid{display:flex;flex-wrap:wrap}
.card{background:#111;padding:20px;border-radius:12px;margin:10px;width:260px}
input{padding:10px;width:90%;margin:10px}
table{width:100%;color:#fff;margin-top:10px}
td{padding:6px;border-bottom:1px solid #333}
</style>
</head>

<body>

<div class="top">
<div class="logo">DimeX Dashboard</div>
<button class="btn" onclick="connect()">Connect Wallet</button>
</div>

<div class="main">

<div id="wallet"></div>
<div id="status"></div>

<div class="grid">

<div class="card"><h3>Total Stake</h3><div id="totalStake">0</div></div>
<div class="card"><h3>Daily Reward</h3><div id="dailyReward">0</div></div>
<div class="card"><h3>Total Income</h3><div id="totalIncome">0</div></div>
<div class="card"><h3>Direct Income</h3><div id="directIncome">0</div></div>
<div class="card"><h3>Level Income</h3><div id="levelIncome">0</div></div>
<div class="card"><h3>Team Count</h3><div id="teamCount">0</div></div>

<div class="card">
<h3>Your Referral Link</h3>
<div id="refLink"></div>
</div>

</div>

<div class="card">
<h3>Stake USDT</h3>
<input id="usdtAmount" placeholder="Amount">
<button onclick="approveUSDT()">Approve</button>
<button onclick="stakeUSDT()">Stake</button>
</div>

<div class="card">
<h3>Stake DX</h3>
<input id="dxAmount" placeholder="Amount">
<button onclick="approveDX()">Approve</button>
<button onclick="stakeDX()">Stake</button>
</div>

<div class="card">
<button onclick="claim()">CLAIM REWARD</button>
</div>

<div class="card">
<h3>Downline</h3>
<table id="teamTable"></table>
</div>

<div class="card">
<h3>Claim History</h3>
<table id="claimTable"></table>
</div>

</div>

<script>

let provider, signer, staking, usdt, dx;

const stakingAddress = "PASTE_STAKING";
const dxAddress = "PASTE_DX";
const usdtAddress = "0x55d398326f99059fF775485246999027B3197955";

const stakingABI = [
 "function stakeUSDT(uint amount,address ref)",
 "function stakeDX(uint amount,address ref)",
 "function claim()",
 "function userInfo(address) view returns(uint,uint,uint,uint,uint,uint)",
 "event Transfer(address indexed from,address indexed to,uint value)"
];

const erc20ABI = [
 "function approve(address spender,uint amount) returns(bool)"
];

function getRef(){
 const p = new URLSearchParams(window.location.search);
 return p.get("ref");
}

async function connect(){

await window.ethereum.request({method:'eth_requestAccounts'});
provider = new ethers.providers.Web3Provider(window.ethereum);
signer = provider.getSigner();

staking = new ethers.Contract(stakingAddress,stakingABI,signer);
usdt = new ethers.Contract(usdtAddress,erc20ABI,signer);
dx   = new ethers.Contract(dxAddress,erc20ABI,signer);

let addr = await signer.getAddress();
document.getElementById("wallet").innerHTML = "Wallet: "+addr;

document.getElementById("refLink").innerHTML =
window.location.origin+"?ref="+addr;

loadData();
loadTeam();
loadClaims();
}

async function loadData(){

let addr = await signer.getAddress();
let d = await staking.userInfo(addr);

document.getElementById("totalStake").innerHTML = ethers.utils.formatUnits(d[0],18);
document.getElementById("dailyReward").innerHTML = ethers.utils.formatUnits(d[1],18);
document.getElementById("totalIncome").innerHTML = ethers.utils.formatUnits(d[2],18);
document.getElementById("directIncome").innerHTML = ethers.utils.formatUnits(d[3],18);
document.getElementById("levelIncome").innerHTML = ethers.utils.formatUnits(d[4],18);
}

async function approveUSDT(){
let amt = document.getElementById("usdtAmount").value;
await usdt.approve(stakingAddress,ethers.utils.parseUnits(amt,18));
}

async function approveDX(){
let amt = document.getElementById("dxAmount").value;
await dx.approve(stakingAddress,ethers.utils.parseUnits(amt,18));
}

async function stakeUSDT(){
let amt = document.getElementById("usdtAmount").value;
let ref = getRef() || "0x0000000000000000000000000000000000000000";

let tx = await staking.stakeUSDT(
 ethers.utils.parseUnits(amt,18),
 ref
);

document.getElementById("status").innerHTML="Staking...";
await tx.wait();
loadData();
}

async function stakeDX(){
let amt = document.getElementById("dxAmount").value;
let ref = getRef() || "0x0000000000000000000000000000000000000000";

let tx = await staking.stakeDX(
 ethers.utils.parseUnits(amt,18),
 ref
);

document.getElementById("status").innerHTML="Staking...";
await tx.wait();
loadData();
}

async function claim(){
let tx = await staking.claim();
document.getElementById("status").innerHTML="Claiming...";
await tx.wait();
loadClaims();
loadData();
}

async function loadTeam(){

let addr = await signer.getAddress();
let filter = staking.filters.Transfer();
let logs = await staking.queryFilter(filter,0,"latest");

let table = document.getElementById("teamTable");
table.innerHTML="";

let count=0;

logs.forEach(l=>{
 if(l.args.to == addr){
   count++;
   let row = table.insertRow();
   row.insertCell(0).innerHTML = l.args.from;
   row.insertCell(1).innerHTML = ethers.utils.formatUnits(l.args.value,18);
 }
});

document.getElementById("teamCount").innerHTML = count;
}

async function loadClaims(){

let addr = await signer.getAddress();
let filter = staking.filters.Transfer(stakingAddress,addr);
let logs = await staking.queryFilter(filter,0,"latest");

let table = document.getElementById("claimTable");
table.innerHTML="";

logs.forEach(l=>{
 let row = table.insertRow();
 row.insertCell(0).innerHTML = new Date().toLocaleString();
 row.insertCell(1).innerHTML = ethers.utils.formatUnits(l.args.value,18);
});
}

</script>
</body>
  </html>
