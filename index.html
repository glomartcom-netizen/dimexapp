<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>DimeX Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.min.js"></script>

<style>
body{margin:0;background:#000;color:#fff;font-family:Arial}
.top{background:#111;padding:20px;display:flex;justify-content:space-between;align-items:center}
.logo{color:gold;font-size:24px}
.btn{background:gold;border:none;padding:12px 20px;border-radius:8px;cursor:pointer}
.btn:disabled{opacity:.4;cursor:not-allowed}

.container{display:flex}
.left{width:60%;padding:20px}
.right{width:40%;padding:20px}

.card{background:#111;padding:20px;border-radius:12px;margin:10px}
.amount{color:gold;font-size:20px;font-weight:bold}

input{
padding:10px;width:90%;margin:10px;background:#000;color:#fff;border:1px solid #333;border-radius:8px
}

table{width:100%;margin-top:10px;border-collapse:collapse}
td,th{padding:8px;border-bottom:1px solid #333}

.small{font-size:12px;color:#aaa}
#status{padding:10px;color:gold}
#wallet{padding:10px;color:#aaa}

@media(max-width:900px){
  .container{flex-direction:column}
  .left,.right{width:100%}
}
</style>
</head>

<body>

<div class="top">
  <div class="logo">DimeX Dashboard</div>
  <div>
    <button class="btn" onclick="connect()">Connect Wallet</button>
  </div>
</div>

<div id="wallet"></div>
<div id="status"></div>

<div class="container">

  <!-- LEFT SIDE -->
  <div class="left">
    <div class="card"><h3>Total Stake</h3><div id="totalStake" class="amount">0</div></div>
    <div class="card"><h3>Daily Reward</h3><div id="dailyReward" class="amount">0</div></div>
    <div class="card"><h3>Direct Income</h3><div id="directIncome" class="amount">0</div></div>
    <div class="card"><h3>Level Income</h3><div id="levelIncome" class="amount">0</div></div>
    <div class="card"><h3>Total Income</h3><div id="totalIncome" class="amount">0</div></div>
    <div class="card"><h3>Team Count</h3><div id="teamCount" class="amount">0</div></div>

    <div class="card">
      <h3 style="color:white">Referral Link</h3>
      <div style="display:flex;gap:10px">
        <input id="refInput" style="color:gold" readonly>
        <button class="btn" onclick="copyRef()">COPY</button>
      </div>
      <div id="copyMsg" class="small"></div>
    </div>
  </div>

  <!-- RIGHT SIDE -->
  <div class="right">

    <div class="card">
      <button class="btn" onclick="toggleStake()">STAKE</button>
    </div>

    <div id="stakeBox" style="display:none">

      <div class="card">
        <h3>Stake USDT</h3>
        <input id="usdtAmount" placeholder="Amount">
        <button class="btn" onclick="approveUSDT()">Approve</button>
        <button class="btn" onclick="stakeUSDT()">Stake</button>
      </div>

      <div class="card">
        <h3>Stake DX</h3>
        <input id="dxAmount" placeholder="Amount">
        <button class="btn" onclick="approveDX()">Approve</button>
        <button class="btn" onclick="stakeDX()">Stake</button>
      </div>

    </div>

    <div class="card">
      <h3>Claimable Reward</h3>
      <div id="claimAmount" class="amount">0</div>
      <br>
      <button id="claimBtn" class="btn" onclick="claim()" disabled>CLAIM</button>
      <div class="small">Minimum 100 DX</div>
    </div>

    <div class="card">
      <button class="btn" onclick="toggleDownline()">VIEW DOWNLINE</button>
      <div id="downlineBox" style="display:none">
        <table id="teamTable"></table>
      </div>
    </div>

    <div class="card">
      <button class="btn" onclick="toggleHistory()">CLAIM HISTORY</button>
      <div id="historyBox" style="display:none">
        <table id="claimTable"></table>
      </div>
    </div>

  </div>
</div>

<script>
let provider, signer, staking, usdt, dx;

const stakingAddress = "PASTE_STAKING";
const dxAddress      = "PASTE_DX";
const usdtAddress    = "0x55d398326f99059fF775485246999027B3197955";

const stakingABI = [
 "function stakeUSDT(uint amount,address ref)",
 "function stakeDX(uint amount,address ref)",
 "function claim()",
 "function userInfo(address) view returns(uint,uint,uint,uint,uint,uint)",
 "event Transfer(address indexed from,address indexed to,uint value)"
];

const erc20ABI = [
 "function approve(address spender,uint amount) returns(bool)"
];

function setStatus(msg){ document.getElementById("status").innerText = msg || ""; }

function toggleStake(){
  let box=document.getElementById("stakeBox");
  box.style.display = box.style.display=="none"?"block":"none";
}

function toggleDownline(){
  let box=document.getElementById("downlineBox");
  box.style.display = box.style.display=="none"?"block":"none";
  if(box.style.display=="block") loadTeam();
}

function toggleHistory(){
  let box=document.getElementById("historyBox");
  box.style.display = box.style.display=="none"?"block":"none";
  if(box.style.display=="block") loadClaims();
}

function getRef(){
  const p=new URLSearchParams(window.location.search);
  return p.get("ref");
}

async function connect(){
  if(!window.ethereum){ alert("Install MetaMask"); return; }

  await window.ethereum.request({method:'eth_requestAccounts'});
  provider=new ethers.providers.Web3Provider(window.ethereum);
  signer=provider.getSigner();

  const net = await provider.getNetwork();
  if(net.chainId !== 56){
    alert("Switch to BSC Mainnet");
    return;
  }

  staking=new ethers.Contract(stakingAddress,stakingABI,signer);
  usdt=new ethers.Contract(usdtAddress,erc20ABI,signer);
  dx   =new ethers.Contract(dxAddress,erc20ABI,signer);

  let addr=await signer.getAddress();
  document.getElementById("wallet").innerHTML="Wallet: "+addr;

  setRefLink();
  await loadData();
  setInterval(loadData,10000);
}

async function setRefLink(){
  let addr=await signer.getAddress();
  let link=window.location.origin+"?ref="+addr;
  document.getElementById("refInput").value=link;
}

function copyRef(){
  let input=document.getElementById("refInput");
  navigator.clipboard.writeText(input.value);
  document.getElementById("copyMsg").innerHTML="Copied!";
  setTimeout(()=>{document.getElementById("copyMsg").innerHTML="";},2000);
}

async function loadData(){
  let addr=await signer.getAddress();
  let d=await staking.userInfo(addr);

  let pending=d[5];

  document.getElementById("totalStake").innerHTML=ethers.utils.formatUnits(d[0],18);
  document.getElementById("dailyReward").innerHTML=ethers.utils.formatUnits(d[1],18);
  document.getElementById("totalIncome").innerHTML=ethers.utils.formatUnits(d[2],18);
  document.getElementById("directIncome").innerHTML=ethers.utils.formatUnits(d[3],18);
  document.getElementById("levelIncome").innerHTML=ethers.utils.formatUnits(d[4],18);

  let formatted=ethers.utils.formatUnits(pending,18);
  document.getElementById("claimAmount").innerHTML=formatted;

  let btn=document.getElementById("claimBtn");
  if(pending>=ethers.utils.parseUnits("100",18)){
    btn.disabled=false;
  }else{
    btn.disabled=true;
  }
}

async function approveUSDT(){
  try{
    setStatus("Approving USDT...");
    let amt=document.getElementById("usdtAmount").value;
    let tx = await usdt.approve(stakingAddress,ethers.utils.parseUnits(amt,18));
    await tx.wait();
    setStatus("USDT Approved");
  }catch(e){ setStatus("Error"); }
}

async function approveDX(){
  try{
    setStatus("Approving DX...");
    let amt=document.getElementById("dxAmount").value;
    let tx = await dx.approve(stakingAddress,ethers.utils.parseUnits(amt,18));
    await tx.wait();
    setStatus("DX Approved");
  }catch(e){ setStatus("Error"); }
}

async function stakeUSDT(){
  try{
    setStatus("Staking USDT...");
    let amt=document.getElementById("usdtAmount").value;
    let ref=getRef()||"0x0000000000000000000000000000000000000000";
    let tx = await staking.stakeUSDT(ethers.utils.parseUnits(amt,18),ref);
    await tx.wait();
    setStatus("Staked");
    loadData();
  }catch(e){ setStatus("Error"); }
}

async function stakeDX(){
  try{
    setStatus("Staking DX...");
    let amt=document.getElementById("dxAmount").value;
    let ref=getRef()||"0x0000000000000000000000000000000000000000";
    let tx = await staking.stakeDX(ethers.utils.parseUnits(amt,18),ref);
    await tx.wait();
    setStatus("Staked");
    loadData();
  }catch(e){ setStatus("Error"); }
}

async function claim(){
  try{
    let btn=document.getElementById("claimBtn");
    btn.disabled=true;
    setStatus("Claiming...");
    let tx = await staking.claim();
    await tx.wait();
    setStatus("Claimed");
    loadData();
    loadClaims();
  }catch(e){ setStatus("Error"); }
}

async function loadClaims(){
  let addr=await signer.getAddress();
  let filter=staking.filters.Transfer(stakingAddress,addr);
  let logs=await staking.queryFilter(filter,0,"latest");

  let table=document.getElementById("claimTable");
  table.innerHTML="";
  logs.forEach(l=>{
    let row=table.insertRow();
    row.insertCell(0).innerHTML=new Date().toLocaleString();
    row.insertCell(1).innerHTML=ethers.utils.formatUnits(l.args.value,18);
  });
}

async function loadTeam(){
  // Simple viewer (optional enhancement later with backend)
  let table=document.getElementById("teamTable");
  table.innerHTML="<tr><td class='small'>Team view requires event indexing. Basic viewer enabled.</td></tr>";
}
</script>

</body>
     </html>
